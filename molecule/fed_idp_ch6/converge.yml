---
- name: Federation Cookbook IdP Part 1 Ch. 6
  hosts: all
  gather_facts: false
  vars:
    homedir: "."
  tasks:
    - ansible.builtin.include_vars:
        file: "../vars/fed_cookbook_idp_vars.yml"
        name: inventory

    - name: "6.1 Upload keystore files"
      ansible.builtin.import_role:
        name: ibm.isam.import_certificate_db
      vars:
        import_certificate_db_kdb: "{{ homedir }}/{{ inventory.import_certificate_db_kdb }}"
        import_certificate_db_sth: "{{ homedir }}/{{ inventory.import_certificate_db_sth }}"

    - name: "6.2 Upload mapping rules"
      ansible.builtin.include_role:
        name: ibm.isam.aac.configure_mapping_rules
      vars:
        mapping_rules: "{{ inventory.mapping_rules }}"

    - name: "6.3 Create Federation: get mapping rule id"
      ansible.builtin.include_role:
        name: ibm.isam.search_mapping_rule
      vars:
        search_mapping_rule_name: "{{ inventory.search_mapping_rule_name }}"

    - name: "6.3 Create Federation: create the federation"
      ansible.builtin.include_role:
        name: ibm.isam.fed.set_federation_from_file
      vars:
        set_federation_from_file:
          - name: "{{ inventory.fed_name }}"
            protocol: "{{ inventory.protocol }}"
            role: "{{ inventory.role }}"
            filename: "{{ inventory.ipfed }}"
            mapping_id: "{{ ret_obj.data }}"

    - name: "6.4 Export meta-data"
      ansible.builtin.include_role:
        name: ibm.isam.fed.export_metadata
      vars:
        export_metadata_name: "{{ inventory.fed_name }}"
        export_metadata_filename: "{{ homedir }}/{{ inventory.export_metadata_filename }}"
